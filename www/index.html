<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>åšç‰©é¤¨å°è¦½æ©Ÿå™¨äººæ§åˆ¶å°</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- roslibjs CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/roslibjs/1.1.0/roslib.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-start py-10 px-4">
  <div class="w-full max-w-2xl bg-white shadow-xl rounded-2xl p-6">
    <h1 class="text-3xl font-bold text-center text-blue-600 mb-6">åšç‰©é¤¨å°è¦½æ©Ÿå™¨äººæ§åˆ¶å°</h1>

    <!-- æ§åˆ¶æŒ‰éˆ• -->
    <div id="buttons" class="grid grid-cols-3 gap-4 mb-6">
      <button onclick="gotoRegion(1)" class="btn">å€åŸŸ 1</button>
      <button onclick="gotoRegion(2)" class="btn">å€åŸŸ 2</button>
      <button onclick="gotoRegion(3)" class="btn">å€åŸŸ 3</button>
      <button onclick="gotoRegion(4)" class="btn">å€åŸŸ 4</button>
      <button onclick="gotoRegion(5)" class="btn">å€åŸŸ 5</button>
      <button onclick="gotoRegion(6)" class="btn">å€åŸŸ 6</button>
      <button onclick="gotoRegion(7)" class="btn">å€åŸŸ 7</button>
      <button onclick="gotoRegion(8)" class="btn">å€åŸŸ 8</button>
      <button onclick="gotoRegion(9)" class="btn">å€åŸŸ 9</button>
    </div>

    <!-- ç‹€æ…‹èˆ‡å°è¦½ -->
    <div class="text-lg space-y-2">
      <p>âœ… ç•¶å‰å€åŸŸï¼š<span id="currentRegion" class="font-semibold text-blue-500">æœªçŸ¥</span></p>
      <p>ğŸ“¢ å°è¦½è³‡è¨Šï¼š<span id="guideText" class="font-medium text-gray-700">è«‹é¸æ“‡ä¸€å€‹å±•å€</span></p>
    </div>
  </div>

  <script>
    const ros = new ROSLIB.Ros({ url: "ws://172.23.206.148:9090" });

    ros.on('connection', () => console.log("Connected to ROSBridge"));
    ros.on('error', (err) => console.error("ROSBridge error", err));
    ros.on('close', () => console.warn("ROSBridge connection lost"));

    const regionTargets = {
      1: { x: 0.5, y: 0.5, theta: 0 },
      2: { x: 0.5, y: -0.5, theta: 0 },
      3: { x: 0.5, y: -1.5, theta: 0 },
      4: { x: -0.5, y: 0.5, theta: 0 },
      5: { x: -0.5, y: -0.5, theta: 0 },
      6: { x: -0.5, y: -1.5, theta: 0 },
      7: { x: -1.5, y: 0.5, theta: 0 },
      8: { x: -1.5, y: -0.5, theta: 0 },
      9: { x: -1.5, y: -1.5, theta: 0 }
    };

    const guideTexts = {
      1: "å€åŸŸ1ï¼šå²å‰æ™‚ä»£å±•å»³ - å±•å‡ºåƒè¬å¹´åŒ–çŸ³èˆ‡å£ç•«ã€‚",
      2: "å€åŸŸ2ï¼šå¤æ–‡æ˜å»³ - ä»‹ç´¹åŸƒåŠèˆ‡å…©æ²³æµåŸŸæ–‡æ˜ã€‚",
      3: "å€åŸŸ3ï¼šç§¦æ¼¢å…µé¦¬ä¿‘å±•å»³ã€‚",
      4: "å€åŸŸ4ï¼šå”å®‹è—è¡“å±•å»³ã€‚",
      5: "å€åŸŸ5ï¼šè¿‘ç¾ä»£æ­·å²å»³ã€‚",
      6: "å€åŸŸ6ï¼šç§‘å­¸èˆ‡å·¥æ¥­é©å‘½å±•ã€‚",
      7: "å€åŸŸ7ï¼šæµ·æ´‹æ–‡åŒ–å±•ã€‚",
      8: "å€åŸŸ8ï¼šåŸä½æ°‘æ—å»³ã€‚",
      9: "å€åŸŸ9ï¼šæ•¸ä½äº’å‹•ç§‘æŠ€å€ã€‚"
    };

    let currentTargetRegion = null;

    const goalTopic = new ROSLIB.Topic({
      ros: ros,
      name: "/move_base_simple/goal",
      messageType: "geometry_msgs/PoseStamped"
    });

    function gotoRegion(regionId) {
      const target = regionTargets[regionId];
      currentTargetRegion = regionId;

      const yaw = target.theta;
      const quat = {
        x: 0,
        y: 0,
        z: Math.sin(yaw / 2),
        w: Math.cos(yaw / 2)
      };

      const goalMsg = new ROSLIB.Message({
        header: { frame_id: "map" },
        pose: {
          position: { x: target.x, y: target.y, z: 0 },
          orientation: quat
        }
      });

      goalTopic.publish(goalMsg);
      console.log(`å·²é€å‡ºå‰å¾€ã€Œå€åŸŸ ${regionId}ã€çš„æŒ‡ä»¤...`);
      document.getElementById("guideText").innerText = `å·²é€å‡ºå‰å¾€ã€Œå€åŸŸ ${regionId}ã€çš„æŒ‡ä»¤...`;
    }

    const statusTopic = new ROSLIB.Topic({
      ros: ros,
      name: "/move_base/status",
      messageType: "actionlib_msgs/GoalStatusArray"
    });

    statusTopic.subscribe((msg) => {
      if (!currentTargetRegion) return;
      const statusList = msg.status_list;
      if (statusList.length > 0) {
        const latest = statusList[statusList.length - 1];
        if (latest.status === 3) {
          document.getElementById("guideText").innerText = guideTexts[currentTargetRegion] || "å·²æŠµé”ï¼";
          currentTargetRegion = null;
        }
      }
    });

    const regionSub = new ROSLIB.Topic({
      ros: ros,
      name: "/current_region",
      messageType: "std_msgs/Int32"
    });

    regionSub.subscribe((msg) => {
      document.getElementById("currentRegion").innerText = msg.data;
    });
  </script>

  <style>
    .btn {
      @apply bg-blue-500 text-white font-semibold py-2 px-4 rounded-xl shadow hover:bg-blue-600 transition duration-200;
    }
  </style>
</body>
</html>
